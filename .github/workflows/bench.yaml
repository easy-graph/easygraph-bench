name: benchmark
on: workflow_dispatch
jobs:
  benchmark:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          path: easygraph-bench

      - name: checkout Easy-Graph
        uses: actions/checkout@v3
        with:
          repository: easy-graph/Easy-Graph
          path: Easy-Graph

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: build and install easygraph
        env:
          python_version: '3.9'
          boost_version: "1.79.0"
        working-directory: Easy-Graph
        run: |          
          python_version_abbr=${python_version//./}
          boost_version_alias=boost_${boost_version//./_}
          sudo apt-get update
          sudo apt-get install gcc -y
          sudo apt-get install g++ -y
          wget https://boostorg.jfrog.io/artifactory/main/release/${boost_version}/source/${boost_version_alias}.tar.gz
          tar -xf ${boost_version_alias}.tar.gz
          cd ${boost_version_alias}
          ./bootstrap.sh --with-python=python
          sudo ./b2 cxxflags="-fPIC" install --with-python
          cd ${{ github.workspace }}
          
          sudo ln -s /usr/local/lib/libboost_python${python_version_abbr}.a /usr/local/lib/libboost_python.a

          pip install pytest
          pip install Pillow
          pip install kiwisolver
          pip install gensim
          pip install lxml
          python setup.py build_ext -l boost_python -L "/usr/local/lib" -I "/usr/local/include"
          python setup.py install
        


      # cSpell:disable
      # - name: Setup upterm session
      #   uses: lhotari/action-upterm@v1
      #   with:
      #     ## limits ssh access and adds the ssh public key for the user which triggered the workflow
      #     limit-access-to-actor: true
      #     ## limits ssh access and adds the ssh public keys of the listed GitHub users
      #     limit-access-to-users: tddschn

      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      # cSpell:enable

      - name: Install dependencies
        working-directory: easygraph-bench
        run: |
          pip install -r requirements.txt

      - name: benchmark
        working-directory: easygraph-bench
        run: |
          python3 ./bench.py

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-images
          path: |
            ${{ github.workspace }}/easygraph-bench/images
            ${{ github.workspace }}/easygraph-bench/*.csv